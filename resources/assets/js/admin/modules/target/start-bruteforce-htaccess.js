/*
 * Author: Damian Schwyrz <mail@damianschwyrz.de>
 * URL: https://www.damianschwyrz.de
 * Copyright (c) 2018.
 */


$(function () {


    $('#prepare-htbrute-modal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);

        var url = button.data("url");
        var route = button.data("href");

        $("#start-htbrute").data("route", route);
        $("#start-htbrute").attr("data-route", route);

        $("#htbrute-url").val(url);
    });

    $('#prepare-htbrute-modal').on('hide.bs.modal', function () {
        $("#htbrute-url").val("");
        $("#start-htbrute").find(".fa").addClass("hidden");

        $("#htbrute-command span").html();

        $("#htbrute-command").fadeOut();
        $("#htbrute-warn").fadeOut();

        $("#htbrute-select-uw").removeClass("btn-default").addClass("btn-success");
        $("#htbrute-select-us").removeClass("btn-success").addClass("btn-default");

        $("#htbrute-type").val("user_wordlist");

        $("#username-list-select").removeClass("hidden");
        $("#username-string-select").addClass("hidden");

    });

    $(document).on('click', "#htbrute-select-uw", function (event) {
        $(this).removeClass("btn-default").addClass("btn-success");
        $("#htbrute-select-us").addClass("btn-default").removeClass("btn-success");
        $("#htbrute-type").val("user_wordlist");

        $("#username-list-select").removeClass("hidden");
        $("#username-string-select").addClass("hidden");

        $("#htbrute-command").fadeOut();
        $("#htbrute-warn").fadeOut();
    });

    $(document).on('click', "#htbrute-select-us", function (event) {
        $(this).removeClass("btn-default").addClass("btn-success");
        $("#htbrute-select-uw").addClass("btn-default").removeClass("btn-success");
        $("#htbrute-type").val("usernames")
        $("#username-list-select").addClass("hidden");
        $("#username-string-select").removeClass("hidden");

        $("#htbrute-command").fadeOut();
        $("#htbrute-warn").fadeOut();
    });

    $(document).on('click', "#start-htbrute", function (event) {
        event.preventDefault();

        var btn = $(this);
        var route = btn.data("route");

        var url = $("#htbrute-url").val();
        var timeout = $("#htbrute-timeout").val();
        var threads = $("#htbrute-threads").val();
        var userlist = $("#htbrute-userlist").val();
        var usernames = $("#htbrute-usernames").val();
        var passlist = $("#htbrute-passlist").val();
        var type = $("#htbrute-type").val();

        if (type === "usernames" && usernames == "") {
            htbruteError("usernames empty!");
            return false;
        }

        if (timeout <= 0 || isNaN(timeout)) {
            htbruteError("timeout has to be bigger than 0!");
            return false;
        }

        if (threads <= 0 || isNaN(threads)) {
            htbruteError("threads has to be bigger than 0!");
            return false;
        }

        if (userlist == "") {
            htbruteError("userlist not found!");
            return false;
        }

        if (passlist == "") {
            htbruteError("passlist not found!");
            return false;
        }

        if (route == "") {
            htbruteError("Route not found!");
            return false;
        }

        if (url == "") {
            htbruteError("URL has to be set!");
            return false;
        }

        btn.find(".fa").removeClass("hidden");

        $.ajax({
            url: route,
            type: 'POST',
            data: {
                type: type,
                url: url,
                threads: threads,
                timeout: timeout,
                userlist: userlist,
                usernames: usernames,
                passlist: passlist
            },
            success: function (result) {
                console.log(result);
                $("#htbrute-command span").html(result.startcommand);

                $("#htbrute-command").fadeIn();
                $("#htbrute-warn").fadeIn();
                btn.find(".fa").addClass("hidden");
            },
            error: function (result) {
                console.log(result.responseJSON);
                htbruteError(result.responseJSON.message);
                btn.find(".fa").addClass("hidden");
            }
        });

    });
});

function htbruteError(message) {

    $("#htbrute-error .alert span").html(message);
    $("#htbrute-error").fadeIn();

    setTimeout(function () {
        $("#htbrute-error").fadeOut("fast");
        $("#htbrute-error .alert span").html("");

    }, 3200);
}